'use strict';

angular.module("ndApp.activityManage",["ui.router","ngGrid","angularBootstrapNavTree","ndApp.shared","ui.bootstrap","angular-confirm"]).config(["$stateProvider","$urlRouterProvider",function($stateProvider,$urlRouterProvider){$stateProvider.state("activity",{"abstract":!0,url:"/activities",templateUrl:"app/activity/activity.jsp"}).state("activity.activityList",{url:"",templateUrl:"app/activity/activity-list.jsp"}).state("activity.activityEdit",{url:"/:activityId",templateUrl:"app/activity/activity-edit.jsp"})}]);
angular.module("ndApp.shared",[]);
angular.module("ndApp.shared").factory("dictService",["$http","$q","translateService","$translate","$rootScope",function($http,$q,translateService,$translate,$rootScope){function initData(){service.Dict.localLang={selectAll:$translate.instant("map.localLang.selectAll"),selectNone:$translate.instant("map.localLang.selectNone"),reset:$translate.instant("map.localLang.reset"),search:$translate.instant("map.localLang.search"),nothingSelected:$translate.instant("map.localLang.nothingSelected")};var testPoint=[{code:0,name:$translate.instant("map.testPoint.dctwdy")},{code:1,name:$translate.instant("map.testPoint.dczywdy")},{code:2,name:$translate.instant("map.testPoint.dcyxdy")},{code:3,name:$translate.instant("map.testPoint.yxdcfy")},{code:7,name:$translate.instant("map.testPoint.dyyxdy")},{code:8,name:$translate.instant("map.testPoint.dhdcdyyy")},{code:9,name:$translate.instant("map.testPoint.jzfyzqd")},{code:10,name:$translate.instant("map.testPoint.jzqf")},{code:11,name:$translate.instant("map.testPoint.jszh")},{code:12,name:$translate.instant("map.testPoint.dhycjtdy")},{code:13,name:$translate.instant("map.testPoint.dhwddy")}];service.Dict.testPoint=testPoint;var LessonTypes=[{id:1,name:$translate.instant("map.testPoint.lesson")},{id:2,name:$translate.instant("map.testPoint.review")},{id:3,name:$translate.instant("map.testPoint.special")}],LessonParts=[{id:0,name:""},{id:1,name:"Part1"},{id:2,name:"Part2"},{id:3,name:"Part3"},{id:4,name:"Part4"},{id:5,name:"Part5"},{id:6,name:"Part6"},{id:7,name:"Part7"},{id:8,name:"Part8"}],ResTypes=[{code:"audio",name:$translate.instant("map.ResTypes.audio")},{code:"img",name:$translate.instant("map.ResTypes.img")},{code:"video",name:$translate.instant("map.ResTypes.video")}],UnlockMode=[{code:"QSJS",name:$translate.instant("map.UnlockMode.QSJS")},{code:"RWJS",name:$translate.instant("map.UnlockMode.RWJS")},{code:"RGJS",name:$translate.instant("map.UnlockMode.RGJS")}],ActivityUnlockMode=[{code:"QSJS",name:$translate.instant("map.UnlockMode.QSJS")},{code:"ZGJS",name:$translate.instant("map.UnlockMode.ZGJS")}],FinishMode=[{code:"HD",name:$translate.instant("map.FinishMode.HD")},{code:"JF",name:$translate.instant("map.FinishMode.JF")}],TestType=[{code:"DC",name:$translate.instant("map.TestType.DC")},{code:"DY",name:$translate.instant("map.TestType.DY")},{code:"JZ",name:$translate.instant("map.TestType.JZ")},{code:"DH",name:$translate.instant("map.TestType.DH")},{code:"TY",name:$translate.instant("map.TestType.TY")}],ActivityCategory=[{code:"LX",name:$translate.instant("map.ActivityCategory.LX")},{code:"YX",name:$translate.instant("map.ActivityCategory.YX")}],ActivityStatus=[{code:"XJ",name:$translate.instant("map.ActivityStatus.XJ")},{code:"CS",name:$translate.instant("map.ActivityStatus.CS")},{code:"QY",name:$translate.instant("map.ActivityStatus.QY")},{code:"JY",name:$translate.instant("map.ActivityStatus.JY")}],SourceType=[{code:"word",name:$translate.instant("map.TestType.DC")},{code:"phrase",name:$translate.instant("map.TestType.DY")},{code:"sentence",name:$translate.instant("map.TestType.JZ")},{code:"dialogue",name:$translate.instant("map.TestType.DH")},{code:"wordimg",name:$translate.instant("map.SourceType.wordimg")},{code:"dialogueimg",name:$translate.instant("map.SourceType.dialogueimg")}],ActivityClientType=[{code:"XS",name:$translate.instant("map.ActivityClientType.XS")},{code:"JS",name:$translate.instant("map.ActivityClientType.JS")}],ResTypeMap={};angular.forEach(ResTypes,function(option){ResTypeMap[option.code]=option.name});var UnlockModeMap={};angular.forEach(UnlockMode,function(option){UnlockModeMap[option.code]=option.name});var FinishModeMap={};angular.forEach(FinishMode,function(option){FinishModeMap[option.code]=option.name});var TestTypeMap={};angular.forEach(TestType,function(option){TestTypeMap[option.code]=option.name});var ActivityClientTypeMap={};angular.forEach(ActivityClientType,function(option){ActivityClientTypeMap[option.code]=option.name});var TestPointMap={};angular.forEach(testPoint,function(option){TestPointMap[option.code]=option.name});var ActivityUnlockModeMap={};angular.forEach(TestType,function(option){ActivityUnlockModeMap[option.code]=option.name});var ActivityCategoryMap={};angular.forEach(ActivityCategory,function(option){ActivityCategoryMap[option.code]=option.name});var ActivityStatusMap={};angular.forEach(ActivityStatus,function(option){ActivityStatusMap[option.code]=option.name});var SourceTypeMap={};angular.forEach(SourceType,function(option){SourceTypeMap[option.code]=option.name}),service.IdNameDict.LessonPart=LessonParts,service.IdNameDict.LessonType=LessonTypes,service.CodeNameDict.ResType=ResTypes,service.CodeNameDict.UnlockMode=UnlockMode,service.CodeNameDict.FinishMode=FinishMode,service.CodeNameDict.TestType=TestType,service.CodeNameDict.ActivityClientType=ActivityClientType,service.CodeNameDict.TestPoint=testPoint,service.CodeNameDict.ActivityUnlockMode=ActivityUnlockMode,service.CodeNameDict.ActivityCategory=ActivityCategory,service.CodeNameDict.ActivityStatus=ActivityStatus,service.CodeNameDict.SourceType=SourceType,service.CodeNameMap.TestPointMap=TestPointMap,service.CodeNameMap.ResType=ResTypeMap,service.CodeNameMap.UnlockMode=UnlockModeMap,service.CodeNameMap.FinishMode=FinishModeMap,service.CodeNameMap.TestType=TestTypeMap,service.CodeNameMap.ActivityClientType=ActivityClientTypeMap,service.CodeNameMap.ActivityUnlockMode=ActivityUnlockModeMap,service.CodeNameMap.ActivityCategory=ActivityCategoryMap,service.CodeNameMap.ActivityStatus=ActivityStatusMap,service.CodeNameMap.SourceType=SourceTypeMap}var service={};service.lessons={},service.Dict={},service.IdNameDict={},service.IdObjDict={},service.CodeNameDict={},service.IdNameMap={},service.CodeNameMap={},service.IdCodeMap={},service.Dict.Activity=[],service.Dict.Lesson=[],service.Dict.Course=[],service.Dict.QuestionWord=[],service.Dict.localLang={},$rootScope.$on("$translateChangeSuccess",function(){initData()}),service.courseLoaded=!1,service.loadCourse=function(){return service.courseLoaded?service.Dict.Course:$http.get("cache/courses").success(function(data){var Course={};angular.forEach(data,function(option){option.name=translateService(option.name),Course[option.id]=option.name,service.Dict.Course.push(option)}),service.IdNameMap.Course=Course,service.courseLoaded=!0})};var lessonSuccessHandler=function(data){service.Dict.Lesson=data,service.Dict.LessonIds=[];var Lesson={},LessonId2Code={};angular.forEach(service.Dict.Lesson,function(option){Lesson[option.id]=option.name,LessonId2Code[option.id]=option.code,service.Dict.LessonIds.push(option.id)}),angular.forEach(data,function(l){service.lessons[l.courseId]||(service.lessons[l.courseId]=[]),service.lessons[l.courseId].push(l)}),service.IdNameMap.Lesson=Lesson,service.IdCodeMap.Lesson=LessonId2Code},dict10Handler=function(data){service.Dict.ClassHourCatalog=data;var ClassHourCatalog={};angular.forEach(service.Dict.ClassHourCatalog,function(option){ClassHourCatalog[option.itemCode]=option.itemValue}),service.CodeNameMap.ClassHourCatalog=ClassHourCatalog},catalogHandler=function(catalogs,dicts){service.Dict["lesson-catalogs"]={},service.IdObjDict.Catalog={},angular.forEach(catalogs,function(c){service.Dict["lesson-catalogs"][c.lessonId]||(service.Dict["lesson-catalogs"][c.lessonId]=[]),c.name=dicts[c.name],service.Dict["lesson-catalogs"][c.lessonId].push(c),service.IdObjDict.Catalog[c.id]=c})},dictLoaded=!1;service.loadDict=function(){if(!dictLoaded){var dict4Promise=$http.get("cache/dicts/4/items").success(function(data){service.Dict.WordCategory=data;var WordCategory={};angular.forEach(service.Dict.WordCategory,function(option){WordCategory[option.itemCode]=option.itemValue}),service.CodeNameMap.WordCategory=WordCategory}),dict6Promise=$http.get("cache/dicts/6/items").success(function(data){service.Dict.ClauseType=data;var ClauseType={};angular.forEach(service.Dict.ClauseType,function(option){ClauseType[option.itemCode]=option.itemValue}),service.CodeNameMap.ClauseType=ClauseType}),dict3Promise=$http.get("cache/dicts/3/items").success(function(data){service.Dict.ResCategory=data;var ResCategory={};angular.forEach(service.Dict.ResCategory,function(option){ResCategory[option.itemCode]=option.itemValue}),service.CodeNameMap.ResCategory=ResCategory}),dict10Promise=$http.get("cache/dicts/10/items").success(dict10Handler),dict11Promise=$http.get("cache/dicts/11/items").success(function(data){service.Dict.TeachingActivityMode=data;var TeachingActivityMode={};angular.forEach(service.Dict.TeachingActivityMode,function(option){TeachingActivityMode[option.itemCode]=option.itemValue}),service.CodeNameMap.TeachingActivityMode=TeachingActivityMode}),dict12Promise=$http.get("cache/dicts/12/items").success(function(data){service.Dict.QuestionWord=data;var QuestionWord={};angular.forEach(service.Dict.QuestionWord,function(option){QuestionWord[option.itemCode]=option.itemValue}),service.CodeNameMap.QuestionWord=QuestionWord}),dict14Promise=$http.get("cache/dicts/14/items").success(function(data){service.Dict.Province=data;var Province={};angular.forEach(service.Dict.Province,function(option){Province[option.itemCode]=option.itemValue}),service.CodeNameMap.Province=Province}),dict15Promise=$http.get("cache/dicts/15/items").success(function(data){service.Dict.Area=data;var Area={};angular.forEach(service.Dict.Area,function(option){Area[option.itemCode]=option.itemValue}),service.CodeNameMap.Area=Area}),activityPromise=$http.get("cache/activities").success(function(data){service.Dict.Activity=data;var Activity={};angular.forEach(service.Dict.Activity,function(option){Activity[option.id]=option.name}),service.IdNameMap.Activity=Activity}),lessonPromise=$http.get("cache/lessons").success(lessonSuccessHandler);return $q.all([dict4Promise,dict6Promise,dict3Promise,activityPromise,lessonPromise,dict10Promise,dict11Promise,dict12Promise,dict14Promise,dict15Promise]).then(function(){dictLoaded=!0})}};var catalogLoaded=!1;return service.loadCatalog=function(){if(!catalogLoaded){var catalogPromise=$http.get("catalogs").success(function(data){service.Dict.Catalogs=data}),dict10Promise=$http.get("cache/dicts/10/items").success(dict10Handler);return $q.all([dict10Promise,catalogPromise]).then(function(){catalogHandler(service.Dict.Catalogs,service.CodeNameMap.ClassHourCatalog),catalogLoaded=!0})}},service.reloadLesson=function(){return $http.get("lessons").success(lessonSuccessHandler)},service}]);
angular.module("ndApp.shared").factory("echartsService",function(){return{echartsDataView:function(opt,columnName){var axisData=opt.xAxis[0].data,series=opt.series,table='<div style="width:100%;height:100%;overflow:auto;"><table class="table table-bordered  table-striped">';table+='<th class="text-center">'+columnName+"</th>",angular.forEach(series,function(s){table+='<th class="text-center">'+s.name+"</th>"});for(var i=0,l=axisData.length;i<l;i++)table+='<tr class="text-center"><td>'+axisData[i]+"</td>",angular.forEach(series,function(s,index,arrar){table+="<td>"+series[index].data[i]+"</td>"}),table+="</tr>";return table+="</tbody></table></div>"},dataView:function(opt,xColumnName,yColumnName){var axisData=opt.xAxis[0].data,series=opt.series,table='<div style="width:100%;height:100%;overflow:auto;"><table class="table table-bordered  table-striped">';table+='<th class="text-center" nowrap="nowrap">'+yColumnName+"|"+xColumnName+"</th>";for(var i=0,l=axisData.length;i<l;i++)table+='<th class="text-center" nowrap="nowrap">'+axisData[i]+"</th>";return angular.forEach(series,function(s){table+='<tr class="text-center"><td nowrap="nowrap">'+s.name+"</td>";for(var i=0,l=axisData.length;i<l;i++)table+='<td nowrap="nowrap">'+s.data[i]+"</td>";table+="</tr>"}),table+="</tbody></table></div>"}}});
angular.module("ndApp.shared").factory("translateService",["$translate",function($translate){var tran=function(key){return key?$translate.instant(key):key};return tran}]);
function ActivityEditCtrl($http,$state,$stateParams,dictService){function closeAlert(index){vm.alerts.splice(index,1)}function submit(){vm.alerts=[],$http.post("activities",vm.activity).success(function(data){$state.go("activity.activityList")}).error(function(data,status){400==status&&(data?vm.alerts.push({msg:data.message}):vm.alerts.push({msg:"发生意外错误"}))})}var vm=this;vm.TestTypeOptions=dictService.CodeNameDict.TestType,vm.ActivityClientTypeOptions=dictService.CodeNameDict.ActivityClientType,vm.alerts=[],vm.closeAlert=closeAlert,vm.activityId=$stateParams.activityId,vm.activity={},vm.submit=submit,$http.get("activities/"+vm.activityId).success(function(data){vm.activity=data})}angular.module("ndApp.activityManage").controller("ActivityEditCtrl",ActivityEditCtrl),ActivityEditCtrl.$inject=["$http","$state","$stateParams","dictService"];
function ActivityListCtrl($http,$state,$stateParams,$confirm,dictService){function select(item){vm.selected=item}function initActivities(){$http.get("activities").success(function(data){vm.activities=data})}var vm=this;vm.TestTypeMap=dictService.CodeNameMap.TestType,vm.ActivityClientTypeMap=dictService.CodeNameMap.ActivityClientType,vm.select=select,vm.activities=[],initActivities()}angular.module("ndApp.activityManage").controller("ActivityListCtrl",ActivityListCtrl),ActivityListCtrl.$inject=["$http","$state","$stateParams","$confirm","dictService"];
app.directive("ensureUnique",["$http","$timeout",function($http,$timeout){var checking=null;return{require:"ngModel",link:function(scope,ele,attrs,c){scope.$watch(attrs.ngModel,function(n){if(n)return attrs.originalValue==n?void c.$setValidity("unique",!0):void(checking||(checking=$timeout(function(){$http({method:"post",url:ctx+"/manage/validate/ensureUnique",data:"field="+attrs.ensureUnique+"&value="+n,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(data){c.$setValidity("unique",data.validity),checking=null}).error(function(data){c.$setValidity("unique",!1),checking=null})},500)))})}}}]),app.directive("passwordVerify",function(){return{require:"ngModel",scope:{passwordVerify:"="},link:function(scope,element,attrs,ctrl){scope.$watch(function(){var combined;return(scope.passwordVerify||ctrl.$viewValue)&&(combined=scope.passwordVerify+"_"+ctrl.$viewValue),combined},function(value){value&&ctrl.$parsers.unshift(function(viewValue){var origin=scope.passwordVerify;return origin!==viewValue?void ctrl.$setValidity("passwordVerify",!1):(ctrl.$setValidity("passwordVerify",!0),viewValue)})})}}});
app.directive("richTextEditor",function(){return{restrict:"A",require:"ngModel",transclude:!0,link:function(scope,element,attrs,ctrl){var textarea=element.wysihtml5({html:!0}),editor=textarea.data("wysihtml5").editor;editor.on("change",function(){editor.getValue()&&scope.$apply(function(){ctrl.$setViewValue(editor.getValue())})}),ctrl.$render=function(){textarea.html(ctrl.$viewValue),editor.setValue(ctrl.$viewValue)},ctrl.$render()}}});
app.directive("schoolClassSelect",["$http",function($http){return{restrict:"E",templateUrl:ctx+"/manage/app/shared/school-class-select.html?v=a1dcd305ba15c1080fc08635a57daf02",replace:!1,scope:{ngModelSchool:"=",ngModelSchoolClass:"="},link:function($scope){$scope.$watch(function($scope){return $scope.ngModelSchool},function(){$scope.searchCla($scope.ngModelSchool.id)},!0)},controller:["$scope","$http","translateService",function($scope,$http,translateService){$http.get(ctx+"/manage/school/listAll").success(function(data){$scope.schools=data,$scope.schools.unshift({id:"",name:"-- "+translateService("select.school")+" --"}),$scope.ngModelSchool=$scope.schools[0]}),$scope.loadSchools=function(item){$scope.ngModelSchool=item},$scope.loadClasss=function(item){$scope.ngModelSchoolClass=item},$scope.searchCla=function(schoolId){$http.get(ctx+"/manage/schoolClass/own",{params:{schoolId:schoolId}}).success(function(data){$scope.schoolClasses=data,$scope.schoolClasses.unshift({id:"",name:"-- "+translateService("select.class")+" --"}),$scope.ngModelSchoolClass=$scope.schoolClasses[0]})}}]}}]);
app.directive("schoolSelect",["$http","translateService",function($http,translateService){return{restrict:"E",require:"ngModel",templateUrl:ctx+"/manage/app/shared/school-select.html?v=a1dcd305ba15c1080fc08635a57daf02",replace:!0,scope:{ngModel:"="},controller:["$scope","$http",function($scope,$http){$scope.loadSchools=function(item){$scope.ngModel=item},$http.get(ctx+"/manage/school/listAll").success(function(data){$scope.schools=data,$scope.schools.unshift({id:"",name:"-- "+translateService("select.school")+" --"}),$scope.ngModel=$scope.schools[0]})}]}}]);